name: CICD pipeline
on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]
jobs:
    tests:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                ports:
                    - 3306:3306
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: test_db
                options: --health-cmd="mysqladmin ping"
        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP with PECL extension
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.4'
                extensions: imagick, swoole

            - name: Copy .env file
              run: |
                cp .env.ci .env

            - name: Install dependencies
              run: |
                composer install -q --no-ansi \
                --no-interaction --no-scripts --no-progress

            - name: Generate application key
              run: |
                php artisan key:generate

            - name: Directory permissions
              run: |
                sudo chown -R $USER:$USER storage bootstrap/cache
                chmod -R 775 storage bootstrap/cache

            - name: phpstan
              run: |
                ./vendor/bin/phpstan analyse --level=5 --memory-limit=1G

            - name: phpinsights
              run: |
                php artisan insights --no-interaction \
                --min-quality=90 --min-complexity=90 \
                --min-architecture=90 --min-style=90 \
                --ansi --format=github-action

            - name: Run tests
              run: |
                php artisan test


